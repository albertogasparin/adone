// @flow
/* eslint-disable no-redeclare */

import type { Node } from 'react';

/**
 * ST: Full basket state
 * PI: Picked basket state (or result)
 * AC: Basket actions
 */

type SetState<ST> = ($Shape<ST>) => void;
type GetState<ST> = () => $ReadOnly<ST>;
type BasketStoreUnsubscribe = () => void;

type RenderPropComponent<S, A> = ($Exact<$ReadOnly<S>> & $Exact<A>) => Node;

export type Basket<ST, AC> = {|
  key: string[],
  initialState: ST,
  actions: AC,
|};

export type BasketStore<ST> = {|
  getState: GetState<ST>,
  setState: ST => void,
  key: string[],
  subscribe: (listener: () => void) => BasketStoreUnsubscribe,
  mutator: SetState<ST>,
|};

export type BasketAction<ST, PR = *, AC = *> = (
  {|
    setState: SetState<ST>,
    getState: GetState<ST>,
    actions: AC,
    dispatch: (actionThunk: BasketAction<ST, PR, AC>) => *,
  |},
  containerProps: PR
) => *;

export type BasketInstance<ST, AC> = {
  store: BasketStore<ST>,
  actions: AC,
};

declare export class Registry {
  configure: ({
    initialStates?: { [key: string]: Object },
  }) => void;
  baskets: Map<string, BasketInstance<any, any>>;
  initBasket: <ST, AC>(key: string, Basket<ST, AC>) => BasketInstance<ST, AC>;
  getBasket: <ST, AC>(
    Basket<ST, AC>,
    scopeId: string
  ) => BasketInstance<ST, AC>;
  deleteBasket: <ST, AC>(Basket<ST, AC>, scopeId: string) => void;
}

declare export var defaultRegistry: Registry;

declare export class AdoneProvider extends React$Component<
  {
    initialStates?: { [key: string]: Object },
  },
  {
    globalRegistry: Registry,
    getBasket: $PropertyType<Registry, 'getBasket'>,
  }
> {
  registry: Registry;
}

type MiddlewareResult = any;
export type Middleware = (
  store: BasketStore<any>
) => (next: (fn: any) => MiddlewareResult) => (fn: () => *) => MiddlewareResult;

declare export var defaults: {
  devtools: boolean,
  middlewares: Set<Middleware>,
  mutator: <ST>(prevState: ST, partialState: $Shape<ST>) => ST,
};

declare export function createComponents<ST, AC, PR>({
  initialState: ST,
  actions: AC,
  name?: string,
  onContainerInit?: () => BasketAction<ST, PR, AC>,
  onContainerUpdate?: () => BasketAction<ST, PR, AC>,
}): {
  Container: React$ComponentType<{ scope?: string, isGlobal?: boolean, ...PR }>,
  Subscriber: React$ComponentType<{
    children: RenderPropComponent<ST, AC>,
  }>,
};

declare export function createSelectorComponent<SE, AC>(
  Subscriber: React$ComponentType<any>,
  selector: (state: any) => SE,
  displayName?: string
): React$ComponentType<{ children: RenderPropComponent<SE, AC> }>;

declare export function createSelectorComponent<AC>(
  Subscriber: React$ComponentType<any>,
  selector: null,
  displayName?: string
): React$ComponentType<{ children: RenderPropComponent<{}, AC> }>;
